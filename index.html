<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីបញ្ជូលទិន្នន័យ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Koulen&family=Moul&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Koulen', sans-serif;
        }
        .moul-font {
             font-family: 'Moul', serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-lg mx-auto bg-white p-8 rounded-2xl shadow-lg">
        <h1 class="text-3xl font-bold text-center mb-2 moul-font text-blue-600">កម្មវិធីបញ្ជូលទិន្នន័យ</h1>
        <p class="text-center text-gray-500 mb-6">សូម​បំពេញ​ព័ត៌មាន​ខាងក្រោម រួច​បញ្ជូន</p>

        <!-- Form for data entry -->
        <form id="dataForm" class="space-y-6">
            <div>
                <label for="id_input" class="block text-lg font-medium text-gray-700">អត្តលេខ</label>
                <input type="text" id="id_input" name="id_input" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-lg">
            </div>

            <div>
                <label for="name_input" class="block text-lg font-medium text-gray-700">ឈ្មោះ</label>
                <input type="text" id="name_input" name="name_input" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-lg">
            </div>

            <!-- Photo Section -->
            <div>
                <label class="block text-lg font-medium text-gray-700">រូបថត</label>
                <div class="mt-2 p-4 border-2 border-dashed border-gray-300 rounded-lg">
                    <!-- Preview Area -->
                    <div id="previewContainer" class="mb-4 text-center">
                         <video id="video" width="100%" playsinline autoplay muted class="rounded-lg hidden"></video>
                         <canvas id="canvas" class="hidden"></canvas>
                         <img id="photoPreview" src="https://placehold.co/400x300/e2e8f0/adb5bd?text=រូបថតរបស់អ្នក" alt="Photo Preview" class="mx-auto rounded-lg max-h-60 w-auto">
                    </div>
                   
                    <!-- Action Buttons -->
                    <div class="flex flex-wrap justify-center gap-3">
                        <button type="button" id="startCameraBtn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                            បើកកាមេរ៉ា
                        </button>
                         <button type="button" id="captureBtn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 hidden">
                            ថតរូប
                        </button>
                        <label for="uploadInput" class="cursor-pointer px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                            ជ្រើសរើសរូបភាព
                            <input type="file" id="uploadInput" accept="image/*" class="hidden">
                        </label>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div>
                <button type="submit" id="submitBtn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-xl font-bold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <span id="submitText">បញ្ជូនទិន្នន័យ</span>
                    <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </form>

        <!-- Status Message -->
        <div id="statusMessage" class="mt-6 text-center text-lg font-medium"></div>
    </div>

    <script>
        // ============================================================================================
        // === ការកំណត់ค่า (CONFIGURATION) ===
        // ============================================================================================
        //  !!! សំខាន់ណាស់ !!!
        //  សូម​ចម្លង Web App URL ដែល​អ្នក​បាន​ Deploy ពី Google Apps Script 
        //  ហើយ​យក​មក​បិទ​ភ្ជាប់​ជំនួស​ឃ្លា 'PASTE_YOUR_APPS_SCRIPT_URL_HERE' ខាងក្រោម​នេះ។
        // ============================================================================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz_0j49bKPyo9DeL3RbEsDcJ_3bt2nr4g43wOCvSPMHsGSoM6mg1UakySpAtvC0YQbZ/exec';
        // ============================================================================================

        // Get DOM elements
        const form = document.getElementById('dataForm');
        const idInput = document.getElementById('id_input');
        const nameInput = document.getElementById('name_input');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const photoPreview = document.getElementById('photoPreview');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const captureBtn = document.getElementById('captureBtn');
        const uploadInput = document.getElementById('uploadInput');
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const statusMessage = document.getElementById('statusMessage');

        let stream; // To hold the camera stream
        let photoData = null;

        // --- Camera Functions ---

        startCameraBtn.addEventListener('click', async () => {
            // Stop any existing stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                video.classList.remove('hidden');
                photoPreview.classList.add('hidden');
                captureBtn.classList.remove('hidden');
                startCameraBtn.textContent = 'ប្តូរ​កាមេរ៉ា';
            } catch (err) {
                console.error("Error accessing camera: ", err);
                alert('មិនអាចបើកកាមេរ៉ាបានទេ។ សូមពិនិត្យមើលការអនុញ្ញាតនៅលើ Browser របស់អ្នក។');
            }
        });

        captureBtn.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            photoData = canvas.toDataURL('image/jpeg');
            photoPreview.src = photoData;
            
            // Show preview and hide video
            video.classList.add('hidden');
            photoPreview.classList.remove('hidden');
            captureBtn.classList.add('hidden');
            startCameraBtn.textContent = 'បើកកាមេរ៉ា';

            // Stop the camera stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // --- File Upload Function ---

        uploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    photoData = e.target.result;
                    photoPreview.src = photoData;
                    video.classList.add('hidden');
                    photoPreview.classList.remove('hidden');
                    // Stop the camera stream if it's running
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        captureBtn.classList.add('hidden');
                        startCameraBtn.textContent = 'បើកកាមេរ៉ា';
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        // --- Form Submission ---

        form.addEventListener('submit', (e) => {
            e.preventDefault();

            // Validate inputs
            if (SCRIPT_URL === 'PASTE_YOUR_APPS_SCRIPT_URL_HERE') {
                showStatus('សូម​កំណត់ SCRIPT_URL នៅក្នុង​ไฟล์ index.html ជាមុនសិន!', 'error');
                return;
            }
             if (!idInput.value.trim() || !nameInput.value.trim()) {
                showStatus('សូម​បញ្ចូល​អត្តលេខ និង ឈ្មោះ!', 'error');
                return;
            }
            if (!photoData) {
                showStatus('សូម​ថតរូប ឬ Upload រូបថត!', 'error');
                return;
            }

            // Disable button and show loader
            setLoading(true);
            
            const submissionData = {
                id: idInput.value.trim(),
                name: nameInput.value.trim(),
                photo: photoData
            };
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json',
                },
                 body: JSON.stringify(submissionData)
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    showStatus(data.message, 'success');
                    form.reset();
                    photoPreview.src = 'https://placehold.co/400x300/e2e8f0/adb5bd?text=រូបថតរបស់អ្នក';
                    photoData = null;
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showStatus('Submission failed: ' + error.message, 'error');
            })
            .finally(() => {
                setLoading(false);
            });
        });

        function setLoading(isLoading) {
            if (isLoading) {
                submitBtn.disabled = true;
                submitText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }
        
        function showStatus(message, type) {
            statusMessage.textContent = message;
            if (type === 'success') {
                statusMessage.className = 'mt-6 text-center text-lg font-medium text-green-600';
            } else {
                statusMessage.className = 'mt-6 text-center text-lg font-medium text-red-600';
            }
             setTimeout(() => {
                statusMessage.textContent = '';
            }, 5000);
        }

    </script>

</body>
</html>

